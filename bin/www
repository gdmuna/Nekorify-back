#!/usr/bin/env node

/**
 * Nekorify 后端服务入口文件
 */

// ==================== 模块依赖 ====================

// 环境变量配置
require("dotenv").config({
  path: `.env.${process.env.NODE_ENV || "development"}`,
});

// Express 及第三方中间件
const express = require("express");
const cookieParser = require("cookie-parser");
const logger = require("morgan");
const cors = require("cors");

// 自定义中间件
const errorHandlerMiddleware = require("../middlewares/errorHandle");
const successResponse = require("../middlewares/successResponse");
const apiProtected = require("../middlewares/apiProtected");

// 路由
const router = require("../routes/index");

// ==================== 应用配置 ====================

/**
 * 创建 Express 应用
 */
const app = express();

// 基础中间件配置
app.use(
  cors({
    origin: "*",
    methods: ["GET", "POST", "PUT", "DELETE"],
  })
); // 允许跨域访问，限制方法
app.use(logger("dev")); // 请求日志
app.use(express.json()); // 解析 JSON 请求体
app.use(express.urlencoded({ extended: true })); // 解析 URL 编码请求体
app.use(cookieParser()); // 解析 Cookie
app.use(successResponse); // 成功响应处理

// API 路由和保护
app.use(apiProtected); // API 鉴权中间件
app.use("/api", router); // API 路由挂载

// 错误处理
app.use(errorHandlerMiddleware); // 全局错误处理中间件

// ==================== 服务器启动 ====================

// 启动服务器
const server = app.listen(
  process.env.PORT || 33001,
  process.env.HOST || "127.0.0.1",
  () => {
    console.log(
      "Server running at http://%s:%s",
      process.env.HOST,
      process.env.PORT
    );
    console.log("Environment=%s", process.env.NODE_ENV);
  }
);
